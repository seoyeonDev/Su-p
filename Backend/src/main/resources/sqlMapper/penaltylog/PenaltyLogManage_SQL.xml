<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="com.example.studyproject.penaltylog.PenaltylogDao">



    <!-- penaltylog 삭제  -->
    <delete id="deletePenaltyLog">
        DELETE FROM penaltylog
        WHERE user_id = #{user_id}
        AND group_id = #{group_id}
    </delete>

    <!-- 유저 아이디로 penaltylog 불러오기 -->
    <select id="getByUserId" resultType="com.example.studyproject.penaltylog.Penaltylog">
        SELECT
            user_id,
            group_id,
            logcontent,
            penalty_round
        FROM penaltylog
        WHERE 1=1
            AND user_id = #{user_id}
    </select>

    <!-- 그룹 아이디로 penaltylog 불러오기 -->
    <select id="getByGroupId" resultType="com.example.studyproject.penaltylog.Penaltylog">
        SELECT
            user_id,
            group_id,
            logcontent,
            penalty_round
        FROM penaltylog
            WHERE 1=1
        AND group_id = #{group_id}
    </select>


    <!--  241102 이서연  -->
    <!--  penalty 기준 이번 주, studylog 개수 조회 // 로직 검토 필요 -->
    <select id="selectPenalty" resultType="map">
        SELECT
            A.group_id
            , A.user_id
            , B.penalty
            , COUNT(C.*)::INT               AS log_count
            , B.penalty &lt;= count(C.*)    AS chk
            , cy.assigncycle
        FROM joinedgroup A
        JOIN sg_assigncycle cy
            ON cy.group_id = A.group_id
            AND now() - INTERVAL '2 day' BETWEEN DATE(cy.startdate) and DATE(cy.enddate)
        LEFT JOIN studygroup B
            ON B.group_id = A.group_id
        LEFT JOIN studylogs C
            ON C.group_id = A.group_id
            AND C.user_id = A.user_id
            AND DATE(c.create_date) BETWEEN DATE(cy.startdate) AND DATE(cy.enddate)
        GROUP BY A.group_id, A.user_id, B.leader_id, B.penalty, cy.assigncycle

    </select>

    <!--  241102 이서연  -->
    <!--  penaltylog 추가
        chk 가 false 일 경우 penalty 추가
        user_id,group_id 마다 추가되어야 함.
        penalty_round 는 해당 주차 (몇회째(회))
    -->
    <insert id="insertPenaltyLog">
        INSERT INTO penaltylog
        (
            user_id
        , group_id
        , logcontent
        , penalty_round
        )
        VALUES (
                #{vo.user_id}
               , #{vo.group_id}
               , CONCAT ('기준 미달 : ', #{log_count}, '/', (SELECT chk_min_cnt as 기준
                                                                   FROM studygroup
                                                                   WHERE group_id = #{vo.group_id}))
               , #{vo.penalty_round}
               )
    </insert>

    <!--  241102 이서연  -->
    <!--  penaltylog 추가 유효성 검사 / 중복 패널티 방지 -->
    <!--  group_id, penalty_round 가 일치할 경우 insert 금지  -->
    <select id="penaltyLogMultiChk" resultType="boolean">
        SELECT COUNT(*) = 0 AS is_empty
        FROM penaltylog
        WHERE group_id = #{group_id}
          AND user_id = #{user_id}
          AND penalty_round = #{penalty_round}
    </select>


</mapper>